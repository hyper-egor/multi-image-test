name: Test branch in docker
on: [ push ]
jobs:
  test-in-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout multi-image-test
        uses: actions/checkout@v3
      - name: Check out conf server
        uses: actions/checkout@master
        with:
             repository: hyper-egor/conf-server
             path: conf-server
      - name: Check out config file
        uses: actions/checkout@master
        with:
              repository:  hyper-egor/example-configs 
              path: conf-server/configs
      - name: Check out solace
        uses: actions/checkout@master
        with:
              repository:   SolaceLabs/solace-single-docker-compose  
              path: solcaeLabs
      - name: build solace 
        run: cd ./solcaeLabs/template&&docker-compose -f PubSubStandard_singleNode.yml up -d
      - name: echo checkout 
        run: pwd&&ls ./solaceLabs
      - name: run solace
        run: docker run -d -p 8080:8080 -p 55555:55555 -p:8008:8008 --shm-size=2g --env username_admin_globalaccesslevel=admin --env username_admin_password=admin --name=solace solace/solace-pubsub-standard
      - name: curl
        uses: wei/curl@v1
        with:
              args: --user "admin:admin" --header "Content-Type: application/json" --request POST -d '{"queueName":"A2Bqueue","accessType":"non-exclusive","egressEnabled":true,"ingressEnabled":true,"permission":"consume"}' http://localhost:8080/SEMP/v2/config/msgVpns/default/queues  
#      - name: createQueue
#        run: curl --user "admin:admin" --header "Content-Type: application/json" --request POST -d '{"queueName":"A2Bqueue","accessType":"non-exclusive","egressEnabled":true,"ingressEnabled":true,"permission":"consume"}' http://localhost:8080/SEMP/v2/config/msgVpns/default/queues  
      - name: build conf-server
        run: gradle build -p ./conf-server
      - name: build conf-server container
        run: gradle docker -p ./conf-server
      - name: run conf-server container
        run: gradle dockerRun -p ./conf-server
        #TODO run solcale container
      - name: build main project
        run: gradle build
      - name: run IT
        run: gradle build -Dconfig_server_host=localhost  --stacktrace -p ./it 
        
        
        
